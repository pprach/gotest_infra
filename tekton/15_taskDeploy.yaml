apiVersion: tekton.dev/v1alpha1
kind: Task
metadata:
  name: update-config
spec:
  params:
    - name: ref
      type: string
    - name: sha
      type: string
    - name: path
      type: string
      default: $(resources.inputs.config-repo.path)
    - name: eventtype
      type: string
    - name: commentsurl
      type: string
  resources:
    inputs:
      - name: config-repo
        type: git
  steps:
    - name: update-config 
      image: alpine/git:v2.24.3
      workingDir: "$(params.path)"
      env:
      - name: secret_env
        valueFrom:
          secretKeyRef:
            name: mysecret
            key: token      
      script: |
        #!/usr/bin/env sh
        branch=$(echo "$(params.ref)" | awk -F '/' '{print $3}')
        if [ "$branch" = "develop" ] ; then
          git config --global user.email bot.github@pprach.pl
          git config --global user.name "Github Bot pprach"
          epochtag=$(date +%s)
          git checkout -b $epochtag
          sed -i '9s/.*/  version: "$(params.sha)"/' helm/gotest/dev.yaml
          git add .
          git commit -m "push from pipeline"
          git push https://pprach:$secret_env@github.com/pprach/gotest_infra.git $epochtag > /dev/null 0>&1 2>&1
          echo "Pushed to git"
        else
          echo "Nothing to do. Bye!"
        fi;
    - name: add-comment
      image: curlimages/curl:7.70.0
      workingDir: "$(params.path)"
      env:
      - name: secret_env
        valueFrom:
          secretKeyRef:
            name: mysecret
            key: token      
      script: |
        #!/usr/bin/env sh
        if [ "$(params.eventtype)" = "pull_request" ] ; then
          comment="https://13.49.70.75:8500/#/namespaces/team-a-building/pipelineruns/"
          build_url=$comment$(echo $HOSTNAME | cut -c 1-26)
          curl -s -u pprach:$secret_env -X POST -d '{"body": "'"$build_url"'"}' "$(params.commentsurl)" > /dev/null 0>&1 2>&1
        else
          echo "Nothing to do. Bye!"
        fi;
